import socket
from scapy.all import *
import nmap

def detect_service_version(target_ip, target_ports):
    service_versions = {}

    for port in target_ports:
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(2)
            result = sock.connect_ex((target_ip, port))

            if result == 0:
                try:
                    sock.sendall(b"HEAD / HTTP/1.1\r\nHost: " + target_ip.encode() + b"\r\n\r\n")
                    response = sock.recv(1024).decode(errors='ignore')

                    banner = response.split("\n")[0]
                    service_versions[port] = banner.strip()
                except:
                    service_versions[port] = "Service detected but version unknown"

            sock.close()
        
        except Exception as e:
            service_versions[port] = f"Error: {str(e)}"

    return service_versions

def advanced_service_detection(target_ip, target_ports):
    nm = nmap.PortScanner()
    service_versions = {}

    nm.scan(target_ip, ",".join(map(str, target_ports)), "-sV")

    for host in nm.all_hosts():
        for proto in nm[host].all_protocols():
            for port in nm[host][proto]:
                service = nm[host][proto][port]
                service_name = service['name']
                service_version = service.get('version', 'Unknown')
                service_versions[port] = f"{service_name} {service_version}"

    return service_versions

if __name__ == "__main__":
    target_ip = "192.168.1.1"
    target_ports = [21, 22, 25, 80, 443, 3306, 8080]

    print("\nRunning Basic Service Detection...\n")
    detected_services = detect_service_version(target_ip, target_ports)
    for port, service in detected_services.items():
        print(f"Port {port}: {service}")

    print("\nRunning Advanced Service Detection (Nmap)...\n")
    advanced_services = advanced_service_detection(target_ip, target_ports)
    for port, service in advanced_services.items():
        print(f"Port {port}: {service}")
